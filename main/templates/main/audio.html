<!DOCTYPE html>
<html lang="en">

<head>
    <title>Sync Audio</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF8">
    <script src="https://unpkg.com/wavesurfer.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">
</head>

<body>
<section class="section">
    <div class="container">
        <div class="columns is-centered">
            <div class="column">
                <div id="waveform"></div>
            </div>
        </div>
        <div class="columns is-centered">
            <div class="column is-6" style="text-align: center">
                <button class="button is-info is-light" onclick="speed(-0.1)">- Speed</button>
                <button class="button is-info is-light" onclick="setSpeed(1)">Speed 100%</button>
                <button class="button is-info is-light" onclick="speed(0.1)">+ Speed</button>
                <button class="button is-primary is-light" onclick="play()" id="play">Play</button>
                <button class="button is-primary is-hidden" onclick="play()" id="pause">Pause</button>
                <button class="button is-warning is-light" onclick="skip(-1)"><<</button>
                <button class="button is-warning is-light" onclick="skip(1)">>></button>
                <input id="volume" style="padding: 10px 0" step="0.001" min="0" max="1" value="0.5" type="range"
                       oninput="volume(this.value)">
            </div>
        </div>
        <div class="columns is-centered">
            <div class="column is-4">
                <h1 class="title">Другие файлы</h1>
                <table class="table is-striped">
                    {% for audio in audios %}
                        <tr>
                            <td>
                                <a href="{% url 'audio' audio.id audio.slug %}">{{ audio.audio.name }}</a>
                            </td>
                        </tr>
                    {% endfor %}
                </table>
            </div>
        </div>
    </div>
</section>

<script>
    var conn;
    const _id = Math.round(Math.random() * 100000);
    var seek;
    window.onload = function () {
        if (window['WebSocket']) {
            const audioId = location.pathname.replace('/', '').split('-')[0];
            conn = new WebSocket(`ws://${location.host}/ws/${audioId}/`);
            conn.onmessage = function (evt) {
                let data = JSON.parse(evt.data)
                if (data.clientId === _id) {
                    return;
                }
                wavesurfer.seekTo(data.position);
                wavesurfer.setPlaybackRate(data.speed);
                if (data.isPlaying) {
                    document.getElementById('play').classList.add('is-hidden');
                    document.getElementById('pause').classList.remove('is-hidden');
                    wavesurfer.play();
                } else {
                    document.getElementById('play').classList.remove('is-hidden');
                    document.getElementById('pause').classList.add('is-hidden');
                    wavesurfer.pause();
                }
            };
        }
    };

    let wavesurfer = WaveSurfer.create({
        container: '#waveform',
        normalize: true,
        waveColor: '#d1d6da',
        progressColor: '#3dbeb3',
        barWidth: 2,
        barRadius: 3,
        barMinHeight: 2,
        cursorWidth: 0,
        partialRender: true,
        responsive: true,
    });
    wavesurfer.load("{{ audio.audio.url }}");
    wavesurfer.on('ready', () => {
        wavesurfer.setVolume(parseFloat(document.getElementById('volume').value));
    })

    let play = () => {
        wavesurfer.playPause();
        document.getElementById('play').classList.toggle('is-hidden');
        document.getElementById('pause').classList.toggle('is-hidden');
        sendMessage();
    };

    let skip = (value) => {
        const step = (wavesurfer.getDuration() / 10);
        wavesurfer.skip(step * Math.sign(value));
        sendMessage();
    };

    let speed = (value) => {
        wavesurfer.setPlaybackRate(wavesurfer.getPlaybackRate() + value);
        sendMessage();
    };

    let setSpeed = (value) => {
        wavesurfer.setPlaybackRate(value);
        sendMessage();
    };

    let volume = (value) => {
        wavesurfer.setVolume(value);
    };

    const volumeInput = document.getElementById('volume');
    let addVolume = (value) => {
        value = Math.min(1, Math.max(0, wavesurfer.getVolume() + value));
        wavesurfer.setVolume(value);
        volumeInput.value = value;
    }

    let sendMessage = function () {
        setTimeout(() => {
            conn.send(JSON.stringify({
                'clientId': _id,
                'isPlaying': wavesurfer.isPlaying(),
                'position': wavesurfer.getCurrentTime() / wavesurfer.getDuration(),
                'speed': wavesurfer.getPlaybackRate(),
            }));
        }, 100);
    };

    document.getElementById('waveform').onclick = () => sendMessage();

    window.onkeydown = (event) => {
        const action = {
            'ArrowLeft': () => {skip(-1)},
            'ArrowRight': () => {skip(1)},
            'ArrowUp': () => {addVolume(0.1)},
            'ArrowDown': () => {addVolume(-0.1)},
            ' ': () => {play()},
        }[event.key];

        if (action) {
            action();
            e.preventDefault();
        }
    };
</script>
</body>

</html>
