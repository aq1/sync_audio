<!DOCTYPE html>
<html lang="en">

<head>
    <title>Chat Example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF8">
</head>

<body>

<script src="https://unpkg.com/wavesurfer.js"></script>

<div id="waveform"></div>
<div>
    <button onclick="play()">play</button>
</div>

{% verbatim %}
<script>
    var conn;
    const _id = Math.round(Math.random() * 100000);
    var seek;
    window.onload = function () {
        if (window["WebSocket"]) {
            conn = new WebSocket("ws://" + document.location.host + "/ws");
            conn.onmessage = function (evt) {
                let data = JSON.parse(evt.data)
                if (data.clientId === _id) {
                    return;
                }
                wavesurfer.seekTo(data.position);
                if (data.isPlaying) {
                    wavesurfer.play();
                } else {
                    wavesurfer.pause();
                }
            };
        }
    };

    var wavesurfer = WaveSurfer.create({
        container: '#waveform',
        normalize: true,
        waveColor: '#d1d6da',
        progressColor: '#3dbeb3',
        barWidth: 2,
        barRadius: 3,
        barMinHeight: 2,
        cursorWidth: 0,
        partialRender: true,
        responsive: true,
    });
    wavesurfer.load('/a');
    wavesurfer.setVolume(1);

    var play = function () {
        wavesurfer.playPause();
        sendMessage();
    };

    let sendMessage = function () {
        setTimeout(() => {
            console.log(wavesurfer.isPlaying());
            conn.send(JSON.stringify({
                'clientId': _id,
                'isPlaying': wavesurfer.isPlaying(),
                'position': wavesurfer.getCurrentTime() / wavesurfer.getDuration(),
            }));
        }, 100);
    };

    document.getElementById('waveform').onclick = () => sendMessage();
</script>
{% endverbatim %}
</body>

</html>
